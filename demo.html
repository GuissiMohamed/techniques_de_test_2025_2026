<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Triangulator •  interactive</title>
<style>
  :root { color-scheme: light dark; --bg:#0b0d10; --panel:#11141a; --muted:#7b8495; --text:#e8edf2; --accent:#4f8cff; --accent-2:#22c55e; --danger:#ef4444; }
  @media (prefers-color-scheme: light) {
    :root { --bg:#f7f8fb; --panel:#ffffff; --muted:#4b5563; --text:#0f172a; --accent:#2563eb; --accent-2:#16a34a; --danger:#dc2626; }
  }
  html, body { height: 100%; margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: linear-gradient(180deg, var(--bg), #0b0d1022); color: var(--text); }
  .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  .card { background: var(--panel); border: 1px solid #ffffff18; border-radius: 16px; box-shadow: 0 10px 30px #00000033; overflow: hidden; }
  header { padding: 18px 20px; display: flex; gap: 16px; align-items: center; justify-content: space-between; border-bottom: 1px solid #ffffff12; }
  h1 { font-size: 20px; margin: 0; letter-spacing:.2px; display:flex; align-items:center; gap:10px }
  .badge { font-size: 12px; color: #fff; background: linear-gradient(135deg, var(--accent), #7c3aed); border-radius: 999px; padding: 4px 10px; }
  .toolbar { padding: 14px 16px; display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items:center; border-bottom: 1px solid #ffffff12; }
  .btn { background: #ffffff08; border: 1px solid #ffffff22; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: .18s ease; font-weight: 600; font-size: 14px; letter-spacing:.2px }
  .btn:hover { transform: translateY(-1px); background: #ffffff12; }
  .btn.primary { background: linear-gradient(135deg, var(--accent), #7c3aed); border: none; }
  .btn.success { background: linear-gradient(135deg, var(--accent-2), #22c55eaa); border:none; }
  .btn.danger { background: linear-gradient(135deg, #ef4444, #f97316); border:none; }
  .canvas-wrap { position: relative; background: repeating-conic-gradient(from 0deg, #ffffff05 0% 25%, transparent 0% 50%) 0 0 / 40px 40px; }
  #canvas { width: 100%; height: 520px; display:block; }
  .statusbar { padding: 10px 14px; display:flex; justify-content: space-between; align-items:center; gap:12px; border-top:1px solid #ffffff12; font-size: 13px; color: var(--muted); }
  .status-ok { color: var(--accent-2); font-weight:700 }
  .status-err { color: var(--danger); font-weight:700 }
  .kbd { background:#ffffff10; border:1px solid #ffffff22; padding:1px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Triangulator <span class="badge">Démo</span></h1>
      <span style="font-size:12px;color:var(--muted);">API: <code>http://localhost:5050/triangulate</code></span>
    </header>

    <div class="toolbar">
      <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnClear">Effacer</button>
        <button class="btn danger" id="btnUndo">Annuler</button>
        <button class="btn" id="btnRandom">Aléatoire</button>
      </div>

      <button class="btn primary" id="btnTri">Trianguler</button>
    </div>

    <div class="canvas-wrap">
      <canvas id="canvas" width="1100" height="520"></canvas>
    </div>

    <div class="statusbar">
      <div>
        <span>Ajout: <span class="kbd">clic</span> • Déplacer: <span class="kbd">glisser</span> • Supprimer: <span class="kbd">Maj+clic</span></span>
      </div>
      <div id="status">Prêt.</div>
    </div>
  </div>
</div>

<script>
const TRI = 'http://localhost:5050';

let points = [];
let triangles = [];
let drag = null;
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');
const statusEl = document.getElementById('status');

function setStatus(msg, type='ok'){
  statusEl.textContent = msg;
  statusEl.className = type === 'ok' ? 'status-ok' : 'status-err';
}

function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);

  // triangles
  ctx.strokeStyle = '#4f8cff';
  ctx.fillStyle = 'rgba(79,140,255,0.14)';
  ctx.lineWidth = 1.2;
  for(const t of triangles){
    const [i,j,k] = t;
    const a = points[i], b = points[j], c = points[k];
    if (!a||!b||!c) continue;
    ctx.beginPath();
    ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.lineTo(c.x,c.y); ctx.closePath();
    ctx.fill(); ctx.stroke();
  }

  // points
  ctx.fillStyle = "#e8edf2";
  for(let i=0;i<points.length;i++){
    const p = points[i];
    ctx.beginPath();
    ctx.arc(p.x,p.y,4,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#9ca3af";
    ctx.font="12px sans-serif";
    ctx.fillText(i, p.x+6, p.y-6);
    ctx.fillStyle="#e8edf2";
  }
}

function pos(e){
  const r = cvs.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}
function nearest(p,r=8){
  for(let i=points.length-1;i>=0;i--){
    const q=points[i];
    if (Math.hypot(q.x-p.x,q.y-p.y)<=r) return i;
  }
  return -1;
}

cvs.addEventListener('mousedown',e=>{
  const p=pos(e);
  const idx=nearest(p);
  if (e.shiftKey && idx>=0){
    points.splice(idx,1);
    triangles=[];
    draw();
    return;
  }
  if (idx>=0){ drag=idx; return; }
  points.push(p);
  triangles=[];
  draw();
});
cvs.addEventListener('mousemove',e=>{
  if (drag==null) return;
  points[drag]=pos(e);
  triangles=[];
  draw();
});
cvs.addEventListener('mouseup',()=>drag=null);

document.getElementById('btnClear').onclick=()=>{ points=[]; triangles=[]; draw(); setStatus("Canvas nettoyé."); };
document.getElementById('btnRandom').onclick=()=>{
  points=[];
  for(let i=0;i<8;i++){
    points.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height});
  }
  triangles=[];
  draw();
  setStatus("Points aléatoires générés.");
};

async function triangulatePoints(rawPoints){
  const r = await fetch(`${TRI}/triangulate`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ points: rawPoints })
  });
  if (!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

document.getElementById('btnTri').onclick=async()=>{
  if (points.length<3){
    setStatus("Ajoute au moins 3 points.", "err");
    return;
  }
  try{
    const raw = points.map(p=>[Math.round(p.x),Math.round(p.y)]);
    const data = await triangulatePoints(raw);
    points = data.points.map(([x,y])=>({x,y}));
    triangles = data.triangles;
    draw();
    setStatus(`Triangulation: ${data.triangle_count} triangle(s).`);
  }catch(e){
    setStatus("Erreur : "+e.message, "err");
  }
};

draw();
</script>
</body>
</html>
